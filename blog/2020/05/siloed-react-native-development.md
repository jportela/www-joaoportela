

---
  title: Siloed React Native Development with Expo and Storybook
  date: "2020-05-11"
  tags:
    - React Native
    - Expo
    - Storybook
    - Monorepo
---

Separating the UI components from the application logic is a good practice, as it promotes a clear separation of concerns, providing easier testing, maintainability and code reuse. By taking advantage of Yarn Workspaces, this boundary can be set even further, by separating the components and the application into different packages. Eventually, we can have multiple applications inside the same repository (as in a monorepo), all using the same component library. This component library, becomes the source of truth for the Design System of your applications. The component library can then be developed in isolation, with components being developed and tested (both manually and automatically) by using a tool such as Storybook, which finally allows for publishing of the Design System to the web, for other developers and designers to review and iterate on.

However, setting this up isn't as easy as it should be. I've been using Expo for a side project and spent almost a week battling bugs and Webpack config issues, trying to get this setup to work.

I was finally able to get it working (TL;DR, check https://github.com/jportela/expo-storybook-workspaces), and in this post I'll go through the steps and hurdles along the way, which gave me a clearer understanding on how Yarn Workspaces work.

### Starting with Yarn Workspaces

Yarn Workspaces enables splitting a project into multiple packages, that all live under the same repository (the monorepo). To set it up, create a `package.json` with the following content:

```js
{
  "private": true,
  "workspaces": [
    "packages/*"
  ]
}
```

The `workspaces` field in this example is configured so that packages all live inside a `packages` directory (you can change this to another parent directory, or even specify a list of directories), so let's create it:

```bash
mkdir packages
```

### Creating the Expo project

Make sure you have the `expo-cli` installed:

```bash
yarn global add expo-cli
```

And create an Expo project. We'll call it `app` for this example:

```bash
cd packages/
expo init app
```

**Note:** Remember to remove the `.git/` directory under `app/`, since you'll want to commit the root of your monorepo. You'll also need to remove `node_modules` and `yarn.lock`:

```bash
cd app/
rm -rf .git/ node_modules/
rm yarn.lock
```

Next we need to make sure the package has a name and a version. Here I'm creating a scoped package (TODO: add link) `@my`, which allows me to import all my packages using an instantly recognizable scope. Edit your `packages/app/package.json`

```js
  "name": "@my/app",
  "version": "1.0.0",
```

### Setting up Expo to play nicely with Yarn Workspaces

By default Expo doesn't work well with Yarn Workspaces. The following steps are needed for them to work: https://github.com/expo/expo/tree/master/packages/expo-yarn-workspaces

Install `expo-yarn-workspaces` on your `app/`:

```bash
yarn add -D expo-yarn-workspaces
```

Add the following script (under the `scripts:` property) to the `app/package.json`:

```js
    "postinstall": "expo-yarn-workspaces postinstall" 
```

And change the `main` entrypoint, to one that will be generated by `expo-yarn-workspaces` (you can choose whatever file name/location for this. Here I've chosen to generate it to the `.expo` directory, since it won't be committed to Git):

```js
  "main": ".expo/__generated__/AppEntry.js",
```

Create a `metro.config.js` file, that contains the following configuration:

```
const { createMetroConfiguration } = require('expo-yarn-workspaces');

module.exports = createMetroConfiguration(__dirname);
```

And finally you need to declare that you want to use that custom Metro configuration on `app.json`:

```js
"packagerOpts": {
  "config": "metro.config.js"
}
```

Run `yarn postinstall`. And finally test if everything is working properly:

```bash
expo web
```

### Setting up the shared library

Now that we have an application up and running, we'll setup the package where the shared UI components will live. We'll call it `ui`:

```bash
cd .. # go to packages
mkdir ui
cd ui/
yarn init -y
```


npx -p @storybook/cli sb init --type react

yarn add -D @expo/webpack-config

//.storybook/webpack.config.js
const { resolve } = require("path");
const { withUnimodules } = require("@expo/webpack-config/addons");

module.exports = ({ config }) => {
  return withUnimodules(config, { projectRoot: resolve(__dirname, "../") });
};

use the same versions as expo

yarn add react@16.9.0 react-dom@16.9.0 react-native-web@0.11.7

change name

yarn add @my/ui@1.0.0

------

Create ui and storybook

ui: yarn init


Errors

compilation.getPathWithInfo is not a function

Module not found: Can't resolve 'react-native-web/dist/exports/Dimensions' in '/Users/jportela/code/jportela/expo-storybook-workspaces/node_modules/expo-asset/build'



https://github.com/expo/examples/tree/master/with-storybook



-----


npx create-react-app ui

